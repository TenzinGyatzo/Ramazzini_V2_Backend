---
wave: 2
depends_on: [02-01]
files_modified:
  - src/modules/giis-export/naming/giis-official-naming.ts
  - src/modules/giis-export/crypto/giis-crypto.service.ts
  - src/modules/giis-export/giis-batch.service.ts
  - src/modules/giis-export/giis-export.controller.ts
  - src/modules/giis-export/giis-export.module.ts
  - docs/nom-024/giis_encryption_spec.md
  - test/nom024/giis-crypto.nom024.spec.ts
  - test/nom024/giis-naming.nom024.spec.ts
autonomous: false
---

# Plan 02-02 — Subfase 2B: Cifrado, empaquetado y naming oficial

**Objetivo:** Implementar naming oficial exacto `[TIPO]-[ENTIDAD][INST]-[AA][MM].[EXT]` con mismo basename para TXT/CIF/ZIP; derivación ENTIDAD+INST desde CLUES (primeros 5 chars) o 99SMP para 9998; cifrado 3DES → .CIF y empaquetado .ZIP con archiver (o adm-zip); cifrado solo si sin bloqueantes, warnings con confirmación. Encoding Windows-1252 preservado hasta antes de cifrar. No hand-roll: crypto nativo para 3DES y SHA-256, archiver/adm-zip para ZIP.

**Restricciones:** No reescribir Phase 1; extender con GiisOfficialNaming y GiisCryptoService. **Gate obligatorio:** `GIIS_ENCRYPTION_VALIDATED=false` por defecto; solo si `true` se permite generar .CIF/.ZIP (si no, 409). Clave 3DES solo desde config segura, 24 bytes; prohibido hardcodear fuera de tests. ZIP regulatorio solo contiene `${basename}.CIF`; Reporte de Excluidos fuera del ZIP (endpoint/CSV aparte). Tests no deben dar falsa confianza: validar IV=8, key=24, algoritmo; dejar explícito que no prueban compatibilidad DGIS.

---

## must_haves

- [ ] **GiisOfficialNaming:** Función o clase que dado `(tipo: 'CDT'|'CEX'|'LES', clues: string, year: number, month: number)` devuelva nombre base (sin extensión) y nombres con extensión .TXT, .CIF, .ZIP. Regla: clues === '9998' o vacío → segmento ENTIDAD+INST = `99SMP`; si no, primeros 5 caracteres del CLUES (trim, uppercase). Formato exacto: `[TIPO]-[ENTIDAD][INST]-[AA][MM]` con AA = 2 dígitos año, MM = 2 dígitos mes. Tests con ejemplos: CLUES DFSSA000864 → LES-DFSSA-2201; 9998 → CDT-99SMP-2410.
- [ ] **Clave 3DES (contrato mínimo):** La clave se obtiene **solo de configuración segura** (env o secret), nunca hardcodeada fuera de tests. Validar longitud **24 bytes**; rechazar o fallar si no cumple. Prohibido hardcodear clave en código de producción.
- [ ] **GiisCryptoService:** (1) Cifrar buffer (Windows-1252 o Buffer) con 3DES → salida .CIF. Usar Node `crypto` (createCipheriv/createDecipheriv); algoritmo `des-ede3-cbc`. Documentar en `docs/nom-024/giis_encryption_spec.md` parámetros (IV 8 bytes, clave 24 bytes, padding, formato .CIF) y sección "Validación pendiente DGIS". (2) Crear ZIP que contenga **exclusivamente** `${basename}.CIF` (ZIP regulatorio solo .CIF). No incluir Reporte de Excluidos dentro del ZIP. (3) Reporte de Excluidos se expone como CSV descargable aparte o endpoint separado (ej. GET `/batches/:id/excluded-report`), no dentro del ZIP entregable. No hand-roll 3DES ni ZIP.
- [ ] **Gate de validación DGIS (obligatorio):** Variable/flag `GIIS_ENCRYPTION_VALIDATED` (env), valor por defecto `false`. Si `false`: el endpoint "generar entregable" responde **409 Conflict** con mensaje: "Cifrado pendiente de validación DGIS; ver docs/nom-024/giis_encryption_spec.md". Solo si `true`: se permite generar .CIF y .ZIP. Permite integrar el código sin prometer compatibilidad hasta validar con DGIS.
- [ ] Flujo en GiisBatchService: tras generar TXT validado (sin bloqueantes; si has_warnings, confirmación explícita), y **solo si GIIS_ENCRYPTION_VALIDATED=true**, (1) leer TXT con encoding Windows-1252, (2) cifrar con GiisCryptoService (clave desde config, 24 bytes), (3) guardar .CIF mismo basename, (4) crear ZIP con **solo** el .CIF, (5) guardar ruta del ZIP en artifacts. Cifrado solo si validationStatus !== 'has_blockers'; con has_warnings exigir flag de confirmación en API.
- [ ] Advertencia 9998: En endpoint de descarga del ZIP o en respuesta de "generar entregable", cuando establecimientoClues === '9998', incluir advertencia explícita Anexo 3 (reporte requiere CLUES válida; archivo podría ser rechazado). No bloquear descarga.
- [ ] Tests: unit naming (primeros 5 CLUES, 99SMP); unit cifrado/descifrado roundtrip (clave/IV de test); **test que valide** IV tamaño = 8 bytes, key = 24 bytes, algoritmo exacto `des-ede3-cbc`; integración TXT → cifra → ZIP con solo .CIF dentro. En spec o README del test: dejar explícito **"Estos tests no prueban compatibilidad con herramienta DGIS"**.

---

## Tasks

<task>
**Task 2B.0 — Gate de validación DGIS (obligatorio)**
- Variable de entorno (o config): `GIIS_ENCRYPTION_VALIDATED`. Valor por defecto: `false`.
- Si `GIIS_ENCRYPTION_VALIDATED` no es `true` (case-insensitive): el endpoint "generar entregable" (cifrar + ZIP) debe responder **409 Conflict** con cuerpo/mensaje: "Cifrado pendiente de validación DGIS; ver docs/nom-024/giis_encryption_spec.md". No ejecutar cifrado ni creación de ZIP.
- Solo si `GIIS_ENCRYPTION_VALIDATED=true`: permitir ejecutar el flujo que genera .CIF y .ZIP. Integrar esta comprobación al inicio del handler de "generar entregable" en GiisExportController (o en el servicio invocado por él). Tests: con flag false, llamada a generar entregable retorna 409; con flag true (en test env), flujo continúa (o mock para no depender de clave real).
</task>

<task>
**Task 2B.1 — Naming oficial y tests**
- Crear `src/modules/giis-export/naming/giis-official-naming.ts`. Exportar función `getOfficialBaseName(tipo: 'CDT'|'CEX'|'LES', clues: string, year: number, month: number): string` y `getOfficialFileName(baseName, ext: 'TXT'|'CIF'|'ZIP')`. Reglas: entidadInst = (clues === '9998' || !clues?.trim()) ? '99SMP' : clues.trim().toUpperCase().slice(0, 5); aa = String(year).slice(-2); mm = String(month).padStart(2, '0'); base = `${tipo}-${entidadInst}-${aa}${mm}`. Asegurar que entidadInst tenga exactamente 5 caracteres (99SMP ya lo es; CLUES puede ser 11, slice(0,5)).
- Crear `test/nom024/giis-naming.nom024.spec.ts`: casos LES-DFSSA-2201, CDT-99SMP-2410, CEX con CLUES 11 chars primeros 5; rechazo o normalización si clues inválida (opcional).
</task>

<task>
**Task 2B.2 — Especificación 3DES y GiisCryptoService**
- Crear `docs/nom-024/giis_encryption_spec.md` con: (1) Algoritmo: 3DES (`des-ede3-cbc`). (2) IV: 8 bytes; documentar si DGIS exige IV fijo o derivado; si no hay especificación, dejar "pendiente de validación con herramienta DGIS". (3) Padding: PKCS7 (o el que indique estándar). (4) Formato .CIF: contenido binario del ciphertext. (5) Clave: **24 bytes**, solo desde configuración segura (env/secret); incluir sección "Validación pendiente" y fecha.
- Crear `src/modules/giis-export/crypto/giis-crypto.service.ts`. Métodos: `encryptToCif(plainBuffer: Buffer, key: Buffer, iv?: Buffer): Buffer` con crypto.createCipheriv('des-ede3-cbc', key, iv); validar key.length === 24. Método `createZipWithCif(cifBuffer: Buffer, officialBaseName: string): Promise<Buffer>` que cree ZIP con **una sola entrada**: `${officialBaseName}.CIF` = cifBuffer (sin Reporte de Excluidos dentro del ZIP). Método `sha256Hex(buffer: Buffer): string`. Clave solo desde config; en producción nunca hardcodear (tests pueden usar Buffer de 24 bytes fijo).
- Tests en `test/nom024/giis-crypto.nom024.spec.ts`: (1) roundtrip encrypt/decrypt con clave e IV de test. (2) **Test explícito:** IV usado tiene longitud 8; key tiene longitud 24; algoritmo es exactamente `des-ede3-cbc`. (3) createZipWithCif produce ZIP que contiene únicamente el archivo .CIF con el nombre oficial. (4) Añadir en el spec o en README/comentario del describe: **"Estos tests validan la implementación local; no prueban compatibilidad con la herramienta DGIS."**
</task>

<task>
**Task 2B.3 — Integración en batch: TXT → CIF → ZIP y API**
- **Gate:** Antes de ejecutar buildDeliverable, comprobar `GIIS_ENCRYPTION_VALIDATED === 'true'` (desde env/config). Si no, responder 409 con mensaje "Cifrado pendiente de validación DGIS; ver docs/nom-024/giis_encryption_spec.md" (véase Task 2B.0).
- GiisBatchService.buildDeliverable (solo se invoca si gate pasa): validación !== 'has_blockers' y (si has_warnings) confirmación recibida. Para cada artifact TXT: (1) leer archivo con encoding Windows-1252; (2) nombre oficial con GiisOfficialNaming; (3) clave desde config segura (validar 24 bytes); (4) cifrar con encryptToCif; (5) escribir .CIF mismo basename; (6) crear ZIP con createZipWithCif(cifBuffer, baseName) — **solo .CIF dentro del ZIP**; (7) guardar ruta del ZIP y hash SHA-256 en artifact. Reporte de Excluidos no va dentro del ZIP; se expone por endpoint separado o descarga CSV aparte (definido en 02-01).
- GiisExportController: (1) "Generar entregable": si GIIS_ENCRYPTION_VALIDATED no es true → 409 con mensaje indicado; si has_warnings y !confirmWarnings → 400/409 confirmación; si OK, ejecutar buildDeliverable. (2) Descarga del ZIP con nombre oficial. (3) Si establecimientoClues === '9998', incluir advertencia Anexo 3 (deliveryWarning). Tests API: con flag false → 409; con flag true, batch validado → ZIP; has_blockers → falla; has_warnings sin confirmación → falla.
</task>

---

## Verification

- Naming: todos los nombres cumplen `[TIPO]-[ENTIDAD][INST]-[AA][MM].[EXT]` y mismo basename para TXT, CIF, ZIP.
- Con `GIIS_ENCRYPTION_VALIDATED=false`, endpoint generar entregable retorna 409 con mensaje que referencia giis_encryption_spec.md. Solo con `true` se generan .CIF y .ZIP.
- Clave 3DES solo desde config segura; longitud 24 bytes validada; sin hardcode en producción.
- ZIP regulatorio contiene exclusivamente `${basename}.CIF`. Reporte de Excluidos fuera del ZIP (CSV o endpoint separado).
- Cifrado: crypto nativo; IV 8 bytes; algoritmo des-ede3-cbc. Tests incluyen aserciones de IV size, key length y algoritmo; y texto explícito de que no prueban compatibilidad DGIS.
- Advertencia 9998 presente cuando CLUES es 9998.

---

## Checkpoints

- **Gate obligatorio:** Hasta que DGIS valide parámetros (o se fije especificación oficial), mantener `GIIS_ENCRYPTION_VALIDATED=false` en entornos que no hayan validado. Con `true` se permite generar entregables; la integración no promete compatibilidad hasta que el gate se active tras validación.
- **3DES / .CIF:** Documentar en giis_encryption_spec.md IV 8 bytes, clave 24 bytes, des-ede3-cbc; sección "Validación pendiente DGIS". No asumir compatibilidad sin verificación con herramienta DGIS.
