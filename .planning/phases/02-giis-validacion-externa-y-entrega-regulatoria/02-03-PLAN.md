---
wave: 3
depends_on: [02-02]
files_modified:
  - src/modules/giis-export/schemas/giis-batch.schema.ts
  - src/modules/giis-export/schemas/giis-export-audit.schema.ts
  - src/modules/giis-export/giis-export-audit.service.ts
  - src/modules/giis-export/giis-batch.service.ts
  - src/modules/giis-export/giis-export.controller.ts
  - src/modules/giis-export/giis-export.module.ts
  - test/nom024/giis-export-audit.nom024.spec.ts
autonomous: true
---

# Plan 02-03 — Subfase 2C: Operación y auditoría

**Objetivo:** Registrar por cada generación (evento de auditoría) quién, cuándo, qué (periodo, CLUES, guía, nombre oficial del archivo), hash SHA-256 del archivo entregado, resumen de validación (ej. N procesados, M excluidos); indicar si el batch fue generado con CLUES 9998 vs CLUES válida. Reintento = nuevo batch (no sobrescribir); versionado interno (v1, v2) opcional; nombre externo siempre el oficial. Retención/limpieza configurable (documentar política; implementación mínima o config para depuración de archivos tras X meses). Alineado con CONTEXT.md y 02-RESEARCH.md.

**Restricciones:** No reescribir Phase 1; extender con modelo de auditoría y GiisExportAuditService. Hash SHA-256 con crypto nativo (ya usado en 2B).

---

## must_haves

- [ ] **Modelo de auditoría:** Colección/schema (ej. GiisExportAudit) con campos: usuarioGeneradorId (o nombre), fechaHora, periodo (yearMonth), establecimientoClues, cluesEs9998 (boolean), tipoGuia (CDT/CEX/LES), nombreArchivoOficial, hashSha256Archivo (hex), resumenValidacion (ej. "150 procesados, 2 excluidos"), batchId (referencia al batch), opcional versionInterna (v1, v2). Cada generación de entregable (TXT+CIF+ZIP o al menos generación de batch completado) produce un documento de auditoría; no sobrescribir.
- [ ] **GiisExportAuditService:** Método `recordGenerationAudit(payload)`: crea documento con los campos anteriores. Llamado desde GiisBatchService al completar la generación del batch (y opcionalmente al generar entregable ZIP). Incluir hash SHA-256 del archivo que se entrega (ZIP o TXT según lo que se considere "entregado"); si 2B ya calcula hash del ZIP, reutilizarlo y pasarlo al audit.
- [ ] **Reintentos y versionado:** Cada vez que el usuario "regenera" (nuevo batch para el mismo periodo/guía), se crea un nuevo batch (ya es así en Phase 1) y un nuevo registro de auditoría. No sobrescribir el log anterior. Nombre del archivo al descargar sigue siendo el oficial (mismo basename); internamente el batch tiene _id distinto. Opcional: campo versionInterna en batch o audit para mostrar "v1", "v2" en UI sin cambiar nombre de archivo.
- [ ] **CLUES 9998 en auditoría:** Campo explícito (cluesEs9998 o similar) para trazabilidad y soporte; permite filtrar o reportar cuáles entregas fueron con 9998.
- [ ] **Retención/limpieza:** Documentar en CONTEXT o en docs la política: archivos ZIP/TXT pueden depurarse tras X meses (configurable); información fuente según NOM-004. Implementación mínima: config (ej. env o config.json) con retentionMonths para archivos generados; tarea o script opcional que liste/elimine archivos antiguos según esa config. No obligatorio implementar job automático en este plan; puede quedar como "documentado + config listo para job futuro".
- [ ] Tests: crear audit al completar batch; verificar campos (usuario, hash, resumen, cluesEs9998); verificar que dos generaciones para mismo periodo producen dos documentos de auditoría.

---

## Tasks

<task>
**Task 2C.1 — Schema de auditoría y GiisExportAuditService**
- Crear `src/modules/giis-export/schemas/giis-export-audit.schema.ts`: schema Mongoose con usuarioGeneradorId (ObjectId o string), fechaHora (Date), periodo (string YYYY-MM), establecimientoClues (string), cluesEs9998 (boolean), tipoGuia (enum CDT/CEX/LES), nombreArchivoOficial (string), hashSha256Archivo (string), resumenValidacion (string), batchId (ObjectId ref GiisBatch), opcional versionInterna (string). Índices útiles: fechaHora, batchId, periodo.
- Crear `src/modules/giis-export/giis-export-audit.service.ts` con método `recordGenerationAudit(payload: AuditPayload): Promise<AuditDocument>`. Validar payload con los campos requeridos. Registrar schema en giis-export.module.ts (MongooseModule.forFeature) y añadir GiisExportAuditService a providers.
- Tests unitarios: recordGenerationAudit crea documento con todos los campos; cluesEs9998 true cuando clues === '9998'.
</task>

<task>
**Task 2C.2 — Integrar auditoría en flujo de generación y entregable**
- En GiisBatchService: al completar generación de un batch (status → completed), llamar a GiisExportAuditService.recordGenerationAudit con: usuario (inyectar o recibir del controller que dispare la generación), fechaHora = now, periodo = batch.yearMonth, establecimientoClues = batch.establecimientoClues, cluesEs9998 = (batch.establecimientoClues === '9998'), tipoGuia por cada artifact (o un registro por artifact si se desea granularidad), nombreArchivoOficial (desde GiisOfficialNaming), hashSha256Archivo (calculado en 2B y guardado en artifact o recalcular aquí), resumenValidacion (ej. "N procesados, M excluidos" desde validationSummary o excludedReport length), batchId = batch._id. Si el entregable (ZIP) se genera en un paso posterior, registrar audit en ese momento con hash del ZIP.
- Asegurar que el usuario generador se pase desde el controller (usuario autenticado). GiisExportController ya tiene acceso al request/user; pasar userId o email al servicio al crear batch o al generar entregable.
- Tests de integración: flujo completo crear batch → generar → completar; verificar que existe exactamente un (o N por guía) documento de auditoría con batchId correcto y hash no vacío.
</task>

<task>
**Task 2C.3 — Reintentos, versionado y política de retención**
- Reintentos: no cambiar comportamiento; cada "crear batch" ya es un nuevo documento. Documentar en código o en CONTEXT que "reintento = nuevo batch, nuevo evento de auditoría, mismo nombre oficial al descargar". Opcional: añadir a GiisBatch campo versionInterna (número o string "v1") calculado por periodo+proveedor (contar batches anteriores para mismo yearMonth y mismo proveedor) para mostrar en UI; no obligatorio para must_have.
- Retención: Añadir en config (ej. `config/giis-export.ts` o env) `retentionMonthsForGeneratedFiles` (número o null = no limpieza). Crear `docs/nom-024/giis_retention_policy.md` con: obligación NOM-004 sobre información fuente (5 años); archivos generados (ZIP/TXT) son vehículos de transmisión; recomendación de depurar tras X meses; esta codebase usa retentionMonthsForGeneratedFiles para un eventual job de limpieza. No implementar el job en este plan salvo que sea trivial (dejar comentario o stub en servicio).
- Tests: dos llamadas a "crear batch" para mismo periodo producen dos batches y dos registros de auditoría; nombres de archivo oficial siguen siendo iguales para mismo periodo/guía/clues.
</task>

---

## Verification

- Cada generación completada produce al menos un registro de auditoría con usuario, fecha, periodo, CLUES, cluesEs9998, guía, nombre archivo, hash SHA-256, resumen validación.
- Reintentos (nuevo batch mismo periodo) no sobrescriben registros anteriores; dos batches → dos audits.
- Tests automatizados pasan para audit service e integración con batch.
- Política de retención documentada y config lista para uso futuro.

---

## Checkpoints

- Ninguno bloqueante. Si se prefiere un registro de auditoría por guía (varios por batch) vs uno por batch con lista de guías, decidir y documentar; el must_have permite "al menos un registro" por generación.
