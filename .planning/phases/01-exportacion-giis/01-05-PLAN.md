---
wave: 5
depends_on: ["01-04"]
files_modified:
  - src/modules/giis-export/giis-export.controller.ts
  - src/modules/giis-export/giis-export.module.ts
  - src/modules/giis-export/giis-batch.service.ts
  - src/modules/proveedores-salud (RegulatoryPolicy / CLUES)
  - test/nom024/giis-export-api.nom024.spec.ts
autonomous: false
---

# Plan 01-05 — Subfase 1E: API (create batch, status, download) + CLUES + gate SIRES

**Objetivo:** Endpoints para crear batch, consultar estado y descargar archivo por guía; resolución CLUES (real vs 9998/SMP) en el pipeline y reflejada en RegulatoryPolicy/UI; solo tenants con `regulatoryPolicy.regime === 'SIRES_NOM024'` pueden crear/ver batches y descargar. Test: crear batch vía API, esperar completed, descargar CDT y verificar encabezado.

**Decisión explícita:** Phase 1 NO incluye 3DES/ZIP. Solo TXT plano.

---

## must_haves

- [ ] **POST** `/api/giis-export/batches` (o bajo proveedores-salud si se prefiere): body `{ yearMonth: "YYYY-MM", onlyFinalized?: boolean }`; resuelve proveedor del usuario autenticado (o desde body si multi-tenant por header). Gate: si regime !== 'SIRES_NOM024' → 403. Resolver CLUES: si proveedor tiene CLUES válida → usar esa; si no → usar "9998" (modo privado SMP). Crear batch con createBatch(proveedorId, yearMonth, options); opcionalmente disparar generación en background o síncrono; respuesta { batchId, status }.
- [ ] **GET** `/api/giis-export/batches/:batchId`: devuelve estado del batch y lista de artifacts (guide, path o URL de descarga, rowCount). Gate: el batch debe pertenecer al proveedor del usuario; si regime !== SIRES → 403.
- [ ] **GET** `/api/giis-export/batches/:batchId/download/:guide**: guide = CDT | CEX | LES; responde con archivo TXT: Content-Type text/plain; charset=windows-1252; Content-Disposition attachment; filename ej. CDT_2025-01.txt. Gate: mismo que GET batch; solo SIRES.
- [ ] Resolución CLUES en pipeline: al crear batch, establecer batch.establecimientoClues = proveedor.clues (trim) si existe y es válido, sino "9998". Todos los mappers (CDT, CEX, LES) reciben este clues en contexto. Documentar o extender RegulatoryPolicy para indicar "uso CLUES real" vs "9998/SMP" (campo o comentario en schema/dto) para que UI pueda mostrarlo.
- [ ] Test integración: usuario/proveedor SIRES → POST batches 2025-01 → 201 + batchId; GET batch/:id → 200 + status + artifacts; GET batch/:id/download/CDT → 200 + body con primera línea = header. Test gate: proveedor SIN_REGIMEN → POST batches → 403.
- [ ] Phase 1 NO incluye 3DES/ZIP.

---

## Tasks

<task>
**Task 5.1 — Resolución CLUES y gate SIRES**
- En GiisBatchService o al crear batch: obtener ProveedorSalud por proveedorSaludId; leer regulatoryPolicy (RegulatoryPolicyService); si regime !== 'SIRES_NOM024' no crear batch (lanzar Forbidden o equivalente). Resolver establecimientoClues: si proveedor tiene clues (string no vacío, válido formato 11 chars o según regla) → usar ese valor; si no (privado sin CLUES) → usar "9998". Guardar en batch.establecimientoClues y pasar a mappers como contexto.
- Opcional: en schema ProveedorSalud o en respuesta de perfil, añadir o documentar campo que indique "exportCluesMode": "real" | "9998" para que la UI muestre "Reporte modo privado (9998/SMP)" cuando aplique.
</task>

<task>
**Task 5.2 — Controller y endpoints**
- Crear o extender `src/modules/giis-export/giis-export.controller.ts`: POST /batches (body yearMonth, onlyFinalized), GET /batches/:batchId, GET /batches/:batchId/download/:guide. Inyectar GiisBatchService, servicio que ejecuta generación (giis-export o batch), y guard que verifica regime SIRES (o middleware). En POST: verificar SIRES, resolver CLUES, createBatch, disparar generación (async o sync), devolver { batchId, status }. En GET batch: verificar pertenencia y SIRES, devolver batch. En GET download: verificar pertenencia y SIRES, leer archivo del path del artifact para esa guide, stream o sendFile con headers Content-Type y Content-Disposition.
- Registrar controller en giis-export.module. Asegurar que rutas estén bajo prefijo correcto (ej. /api/giis-export si aplica).
</task>

<task>
**Task 5.3 — Tests API y gate**
- Crear `test/nom024/giis-export-api.nom024.spec.ts` (o e2e): con proveedor SIRES y fixtures, POST /api/giis-export/batches { yearMonth: "2025-01" } → 201, body con batchId. GET /api/giis-export/batches/:batchId → 200, status completed (o polling hasta completed), artifacts con al menos CDT. GET /api/giis-export/batches/:batchId/download/CDT → 200, body string contiene primera línea con nombres de variables (header). Con proveedor SIN_REGIMEN, POST batches → 403.
- Verificar que descarga devuelve encoding correcto (windows-1252) si se valida en test.
</task>

---

## Verification

- curl o test: POST → 201; GET status → 200; GET download/CDT → 200 y contenido con header.
- Solo tenants SIRES_NOM024 pueden crear y descargar.
- CLUES resuelta a real o 9998 y usada en todos los exports del batch.
- Phase 1 NO incluye 3DES/ZIP (documentado en CONTEXT y en este plan).
