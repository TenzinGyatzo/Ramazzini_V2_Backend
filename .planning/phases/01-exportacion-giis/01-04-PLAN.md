---
wave: 4
depends_on: ["01-03"]
files_modified:
  - src/modules/giis-export/transformers/les.mapper.ts
  - src/modules/giis-export/giis-export.service.ts
  - test/nom024/giis-export-les.nom024.spec.ts
autonomous: true
---

# Plan 01-04 — Subfase 1D: Export LES (B013 Lesiones)

**Objetivo:** Mismo patrón para guía LES: mapper LES (documento Lesión → objeto plano 82 campos); schema `docs/nom-024/giis_schemas/LES.schema.json` como fuente de verdad; reutilizar serializer y validator; artifact LES guardado en batch. Reutilizar/adaptar lógica existente de `transformers/lesion.transformer.ts` si existe, pero salida debe ser objeto plano con keys del schema LES (no lista de strings hardcodeada).

**Regla dura:** NO hardcodear listas de campos. Header y columnas desde LES.schema.json.

---

## must_haves

- [ ] Cargar LES.schema.json vía schema-loader (guide 'LES').
- [ ] Mapper LES: entrada = documento Lesion (Mongoose) o DTO + contexto { clues }; salida = Record con 82 keys = field.name del schema LES. Reutilizar formatters existentes (date, sexo, field) donde aplique; iterar schema.fields para construir objeto, no lista fija de nombres.
- [ ] Flujo de batch: generar artifact LES (lesiones del periodo/proveedor) → serializar, validar, escribir LES.txt (o convención), actualizar batch.artifacts.
- [ ] Test: fixture 1 lesión → mapper LES → 82 keys; archivo LES con header + 1 fila de 82 columnas.
- [ ] Phase 1 NO incluye 3DES/ZIP.

---

## Tasks

<task>
**Task 4.1 — Mapper LES schema-driven**
- Crear o refactorizar `src/modules/giis-export/transformers/les.mapper.ts`: loadGiisSchema('LES'); entrada = Lesion document + { clues }; construir Record<string, string|number> iterando schema.fields y asignando valor desde documento (mapeo campo schema → campo documento) o default. Reutilizar helpers de `transformers/lesion.transformer.ts` (ej. formateo fecha, sexo) pero la salida debe ser objeto plano con keys = schema field names, no hardcodear orden de columnas.
- Test unit: mapper con fixture lesión (ej. lesion.fixtures.ts) + clues → output 82 keys; clues presente; campos obligatorios con valor o default.
</task>

<task>
**Task 4.2 — Integración LES en generación de batch**
- En servicio de generación: después de CDT y CEX, generar LES: cargar lesiones del yearMonth y proveedor (o establecimiento); mapper LES por cada una; serializar con schema LES; validar; escribir archivo; push artifact { guide: 'LES', path, rowCount } a batch.
- Decidir nombre de archivo (ej. LES_{yearMonth}_{clues}.txt) y mantener convención en 1B/1C/1D.
</task>

<task>
**Task 4.3 — Test LES end-to-end**
- Crear `test/nom024/giis-export-les.nom024.spec.ts`: batch con generación completa; verificar artifact LES; contenido archivo: header = nombres del schema LES, filas con 82 columnas. Reutilizar fixtures de lesion existentes.
</task>

---

## Verification

- Tests nom024 pasan para LES.
- Ningún array de nombres de campos hardcodeado para LES; todo desde LES.schema.json.
