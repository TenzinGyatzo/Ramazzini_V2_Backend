---
wave: 1
depends_on: []
files_modified:
  - src/modules/giis-export/schemas/giis-batch.schema.ts
  - src/modules/giis-export/giis-batch.service.ts
  - src/modules/giis-export/giis-export.module.ts
  - test/nom024/giis-batch.nom024.spec.ts
autonomous: true
---

# Plan 01-01 — Subfase 1A: Pipeline base y esquema GiisBatch

**Objetivo:** Esquema `GiisBatch` en MongoDB; servicio que crea un registro de batch (periodo + tenant) en estado `pending` o `generating`; sin generación de archivos aún. Verificación: test que crea batch y lee estado.

**Decisión explícita:** Phase 1 NO incluye 3DES ni ZIP; solo TXT plano.

---

## must_haves

- [ ] Colección/schema Mongoose `GiisBatch` con: `proveedorSaludId`, `establecimientoClues` (string: CLUES real o `"9998"`), `yearMonth` (string `"YYYY-MM"`), `status` (`pending` | `generating` | `completed` | `failed`), `artifacts` (array `{ guide, path, rowCount? }`), `startedAt`, `completedAt`, `errorMessage?`, `options?` (ej. onlyFinalized).
- [ ] Servicio (ej. `GiisBatchService`) con método `createBatch(proveedorSaludId, yearMonth, options?)` que crea documento con status `pending` o `generating` y devuelve el batch (con `_id`).
- [ ] Método `getBatch(batchId)` que devuelve el documento por ID.
- [ ] Test en `test/nom024/giis-batch.nom024.spec.ts`: crear batch con proveedorId + yearMonth, leer por ID, verificar campos (status, yearMonth, proveedorSaludId).

---

## Tasks

<task>
**Task 1.1 — Schema GiisBatch**
- Crear `src/modules/giis-export/schemas/giis-batch.schema.ts`.
- Definir interfaz/schema Mongoose con los campos indicados en must_haves (proveedorSaludId, establecimientoClues, yearMonth, status, artifacts, startedAt, completedAt, errorMessage, options).
- Exportar schema e interfaz para uso en servicio y tests.
</task>

<task>
**Task 1.2 — GiisBatchService y registro en módulo**
- Crear `src/modules/giis-export/giis-batch.service.ts`.
- Implementar `createBatch(proveedorSaludId: string, yearMonth: string, options?: { onlyFinalized?: boolean })`: crea documento GiisBatch con status `pending`, establecimientoClues vacío por ahora (se resolverá en 1E), startedAt = now, artifacts = [].
- Implementar `getBatch(batchId: string)` que busca por _id y devuelve el documento (o null).
- Registrar schema en `giis-export.module.ts` (MongooseModule.forFeature) y añadir GiisBatchService a providers y exports.
</task>

<task>
**Task 1.3 — Test crear y leer batch**
- Crear o extender `test/nom024/giis-batch.nom024.spec.ts`.
- Usar MongoDB memory y fixtures de proveedor si hace falta.
- Test: llamar createBatch(proveedorId, "2025-01"), obtener batchId, llamar getBatch(batchId), expect status === 'pending', yearMonth === '2025-01', proveedorSaludId correcto.
</task>

---

## Verification

- `npm run test:nom024` incluye el nuevo spec y pasa.
- No se generan archivos en disco; solo persistencia del documento batch.
