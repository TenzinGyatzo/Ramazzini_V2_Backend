---
wave: 3
depends_on: ["01-02"]
files_modified:
  - src/modules/giis-export/transformers/cex.mapper.ts
  - src/modules/giis-export/giis-export.service.ts
  - test/nom024/giis-export-cex.nom024.spec.ts
autonomous: true
---

# Plan 01-03 — Subfase 1C: Export CEX (B015 Consulta externa)

**Objetivo:** Mismo patrón que 1B para la guía CEX: mapper CEX (eventos de consulta externa → objeto plano de 106 campos); usar schema `docs/nom-024/giis_schemas/CEX.schema.json` como única fuente de verdad para header y orden; serializer y validator ya existentes (reutilizar); artifact CEX guardado y asociado al batch. Test: 1 fila válida CEX.

**Regla dura:** NO hardcodear listas de campos. Header y columnas desde CEX.schema.json.

---

## must_haves

- [ ] Cargar CEX.schema.json vía schema-loader (extender si hace falta para guide 'CEX').
- [ ] Mapper CEX: entrada = documento o DTO de consulta externa (definir fuente: ¿colección/aggregate existente o vista sobre expedientes?) + contexto { clues }; salida = Record con keys = field.name del schema CEX (106 campos). Defaults/vacíos según requiredColumn.
- [ ] Flujo de batch: al generar batch, además de CDT (si hay detecciones), generar CEX: cargar eventos consulta externa del periodo, mapper CEX → rows, serializar con schema CEX, validar filas, escribir CEX_2025-01.txt (o convención), actualizar batch.artifacts con { guide: 'CEX', path, rowCount }.
- [ ] Test: fixture 1 consulta externa (o objeto mínimo) → mapper CEX → objeto plano con 106 keys; serializar → header + 1 fila con 106 columnas; archivo CEX en artifacts del batch.
- [ ] Phase 1 NO incluye 3DES/ZIP.

---

## Tasks

<task>
**Task 3.1 — Mapper CEX y fuente de datos**
- Definir fuente de datos para "consulta externa" (B015): si existe colección o agregación en expedientes que represente consulta externa, usarla; si no, definir DTO o documento mínimo y fixture.
- Crear `src/modules/giis-export/transformers/cex.mapper.ts`: cargar schema CEX vía loadGiisSchema('CEX'); mapear documento consulta externa + contexto { clues } → Record con 106 keys (field.name del schema). Aplicar defaults para campos sin valor según requiredColumn; no hardcodear lista de nombres, iterar schema.fields.
- Test unit: mapper con fixture → output tiene 106 keys; valores para clues y campos obligatorios presentes.
</task>

<task>
**Task 3.2 — Integración CEX en generación de batch**
- En el servicio que genera el batch (giis-export.service o giis-batch.service): después de generar artifact CDT (si aplica), generar CEX: cargar eventos consulta externa del yearMonth y proveedor; mapper CEX por cada uno; serializar con schema CEX (mismo serializer 1B); validar filas; escribir archivo en mismo directorio (ej. CEX.txt o CEX_{yearMonth}.txt); push a batch.artifacts { guide: 'CEX', path, rowCount }.
- Asegurar que batch tenga ambos artifacts (CDT y CEX) cuando ambos tengan datos; si no hay datos para CEX, no crear archivo vacío o crear con solo header (definir en implementación: solo header aceptable para "0 registros").
</task>

<task>
**Task 3.3 — Test CEX end-to-end**
- Crear `test/nom024/giis-export-cex.nom024.spec.ts`: crear batch; ejecutar generación con al menos 1 evento consulta externa (fixture); verificar batch.artifacts incluye entry guide 'CEX'; leer archivo CEX → primera línea = header (nombres del schema CEX), segunda línea con 106 columnas separadas por |.
</task>

---

## Verification

- Tests nom024 pasan para CEX.
- Header y conteo de columnas salen de CEX.schema.json únicamente.
