---
wave: 2
depends_on: [05-01]
files_modified:
  - src/modules/medicos-firmantes/medicos-firmantes.controller.ts
  - src/modules/medicos-firmantes/medicos-firmantes.service.ts
  - src/modules/medicos-firmantes/medicos-firmantes.module.ts
  - src/modules/enfermeras-firmantes/enfermeras-firmantes.controller.ts
  - src/modules/enfermeras-firmantes/enfermeras-firmantes.service.ts
  - src/modules/enfermeras-firmantes/enfermeras-firmantes.module.ts
  - src/modules/tecnicos-firmantes/tecnicos-firmantes.controller.ts
  - src/modules/tecnicos-firmantes/tecnicos-firmantes.service.ts
  - src/modules/tecnicos-firmantes/tecnicos-firmantes.module.ts
autonomous: false
---

# Plan 05-03 — Instrumentación de eventos de perfiles de firmantes en el Audit Trail

**Objetivo:** Registrar en el Audit Trail la creación y actualización de perfiles de firmantes (medicoFirmante, enfermeraFirmante, tecnicoFirmante). Creación: payload con snapshot del perfil sin binarios (firma como "presente" u omitida). Actualización: payload con antes y después (formato a criterio; sin binarios). resourceType según entidad; CLASS_1_HARD_FAIL.

**Contexto (05-CONTEXT.md):** Tres entidades en módulos separados. Relación 1:1 con User. No guardar en payload: firma, firmaConAntefirma (binarios); solo indicador "presente" si aplica. proveedorSaludId y actorId del usuario autenticado que crea/actualiza.

---

## must_haves

- [ ] **MedicoFirmante:** Tras create (POST registrar-medico) registrar SIGNER_PROFILE_CREATED con resourceType = 'medicoFirmante', resourceId = doc._id. Tras update (PATCH actualizar-medico/:id) registrar SIGNER_PROFILE_UPDATED con payload que incluya antes y después (snapshots sin binarios).
- [ ] **EnfermeraFirmante:** Misma lógica con resourceType = 'enfermeraFirmante'.
- [ ] **TecnicoFirmante:** Misma lógica con resourceType = 'tecnicoFirmante'.
- [ ] **Payload creación:** Snapshot del documento recién creado: todos los campos del schema excepto firma/firmaConAntefirma; para firma puede ser `firma: 'presente'` si existe o omitir. Incluir nombre, tituloProfesional, numeroCedulaProfesional, curp, tipoPersonalId, idUser, etc.
- [ ] **Payload actualización:** Objeto con `before` y `after` (cada uno snapshot sin binarios). Formato exacto a criterio del implementador (objetos completos o solo campos modificados); debe quedar claro el antes y el después.
- [ ] **Actor y proveedor:** En cada controller, inyectar AuditService y obtener actorId (getUserIdFromRequest(req)) y proveedorSaludId (usersService.getIdProveedorSaludByUserId(actorId)). Los módulos de firmantes deben importar AuditModule y opcionalmente UsersModule (o un helper) para obtener proveedorSaludId; evitar dependencias circulares.
- [ ] **Helpers de snapshot:** Crear una función (por módulo o compartida) que, dado un doc de firmante, devuelva un objeto plano sin campos binarios (firma, firmaConAntefirma); si firma existe, incluir firma: 'presente'.

---

## Tasks

<task>
**Task 05-03.1 — Helper snapshot sin binarios**
- Crear utilidad (ej. en cada módulo o en src/utils/) que reciba un documento medico/enfermera/tecnico firmante y devuelva un objeto para payload: todas las propiedades excepto firma y firmaConAntefirma; si doc.firma existe, añadir firma: 'presente'; si doc.firmaConAntefirma existe (solo MedicoFirmante), añadir firmaConAntefirma: 'presente'. Usar toObject() o lean() y luego omitir/clonar sin esos campos. Idempotente y sin mutar el doc original.
</task>

<task>
**Task 05-03.2 — MedicosFirmantes: create y update**
- medicos-firmantes.module: importar AuditModule; inyectar AuditService en el controller. Si se necesita proveedorSaludId, importar UsersModule o inyectar UsersService y usar getIdProveedorSaludByUserId(actorId).
- medicos-firmantes.controller create (POST registrar-medico): después de medicosFirmantesService.create(), obtener actorId con getUserIdFromRequest(req) — añadir @Req() req: Request y importar getUserIdFromRequest desde utils/auth-helpers. Obtener proveedorSaludId. Llamar auditService.record(SIGNER_PROFILE_CREATED, resourceType: 'medicoFirmante', resourceId: medico._id.toString(), payload: snapshot sin binarios del medico creado, proveedorSaludId, actorId, CLASS_1_HARD_FAIL).
- medicos-firmantes.controller update (PATCH actualizar-medico/:id): antes de update, obtener documento actual (findOne(id)). Después de update, construir payload con before: snapshot(docAnterior), after: snapshot(medicoActualizado). record(SIGNER_PROFILE_UPDATED, resourceType: 'medicoFirmante', resourceId: id, payload: { before, after }, proveedorSaludId, actorId, CLASS_1_HARD_FAIL).
</task>

<task>
**Task 05-03.3 — EnfermerasFirmantes: create y update**
- Misma estructura que 05-03.2: enfermeras-firmantes.module importa AuditModule; controller inyecta AuditService; en create registrar SIGNER_PROFILE_CREATED con resourceType 'enfermeraFirmante'; en update registrar SIGNER_PROFILE_UPDATED con before/after. Usar helper de snapshot (campo firma, sin firmaConAntefirma en schema de enfermera).
</task>

<task>
**Task 05-03.4 — TecnicosFirmantes: create y update**
- Misma estructura: tecnicos-firmantes.module importa AuditModule; controller inyecta AuditService; create → SIGNER_PROFILE_CREATED resourceType 'tecnicoFirmante'; update → SIGNER_PROFILE_UPDATED con before/after. Snapshot sin binarios.
</task>

---

## Verification

- Crear medico firmante → evento SIGNER_PROFILE_CREATED con resourceType medicoFirmante y payload sin binarios (firma como 'presente' si existe).
- Actualizar medico firmante → evento SIGNER_PROFILE_UPDATED con payload.before y payload.after.
- Igual para enfermera y tecnico firmantes.
- Lista de auditoría muestra los nuevos eventos; filtro por actionType SIGNER_PROFILE_CREATED / SIGNER_PROFILE_UPDATED y por resourceType medicoFirmante/enfermeraFirmante/tecnicoFirmante funciona.
- Si audit falla, la operación de create/update debe fallar (CLASS_1_HARD_FAIL).

---

## must_haves (checklist final)

- [ ] Los tres módulos (medicos, enfermeras, tecnicos) importan AuditModule e instrumentan create y update.
- [ ] Payload de creación: snapshot sin firma/firmaConAntefirma como binario; indicador "presente" si aplica.
- [ ] Payload de actualización: before y after sin binarios.
- [ ] actorId y proveedorSaludId obtenidos del request (usuario autenticado).
