---
wave: 2
depends_on: [04-01]
files_modified:
  - src/modules/audit/schemas/audit-event.schema.ts
  - src/modules/audit/schemas/audit-outbox.schema.ts
  - src/modules/expedientes/schemas/document-version.schema.ts
  - src/modules/giis-export/schemas/giis-export-audit.schema.ts
  - src/modules/audit/audit.module.ts
  - src/modules/giis-export/giis-export.module.ts
autonomous: false
---

# Plan 04-02 — Capa 2: Cambios de dominio y datos (AuditEvent, versionado, proveedorSaludId, índices)

**Objetivo:** Modelo de datos: colección AuditEvent append-only con proveedorSaludId e índices; esquema de versiones de documentos (snapshot completo por versión); proveedorSaludId en GiisExportAudit; audit_outbox para Clase 2. Separar explícitamente "modelo de datos" (schemas, índices) de "wiring/integración" (que va en 04-03).

**Migraciones:** Añadir `proveedorSaludId` a GiisExportAudit; si existen documentos en `giisexportaudits` sin proveedorSaludId, decidir: backfill por batchId→proveedor o dejar null y filtrar en consultas. No hay migración de datos para AuditEvent ni document_versions (colecciones nuevas).

---

## must_haves

- [ ] **Schema AuditEvent** (Mongoose): proveedorSaludId (ObjectId, required), actorId (ObjectId o string "SYSTEM"), timestamp (Date, required), actionType (string, enum), resourceType (string, opcional), resourceId (string, opcional), payload (Mixed, opcional), hashEvento (string, required), hashEventoAnterior (string, opcional). Colección append-only: no exponer update/delete en servicio. Índices: (proveedorSaludId, timestamp), (proveedorSaludId, actorId, timestamp), (proveedorSaludId, resourceType, resourceId, timestamp) según D5.
- [ ] **Schema audit_outbox:** id, proveedorSaludId, actorId, timestamp, actionType, payload (serializado), eventClass, createdAt, processedAt (null hasta drenado), errorMessage (opcional). Para eventos Clase 2 cuyo registro falló; proceso de drenado/reintento queda documentado pero implementación mínima (escribir y listar para alertas).
- [ ] **Schema document_versions (o equivalente):** por documento clínico resguardado, guardar snapshot completo por versión. Campos: documentType, documentId (referencia lógica al doc original), version (número), snapshot (documento completo), proveedorSaludId, createdAt, createdBy. Índice (proveedorSaludId, documentType, documentId, version) para consulta "obtener versión N".
- [ ] **GiisExportAudit:** añadir campo `proveedorSaludId` (ObjectId, required para nuevos; opcional para compatibilidad con datos existentes). Nuevo índice (proveedorSaludId, fechaHora). Migración: script o comentario que indique "si hay datos históricos, backfill proveedorSaludId desde batch.proveedorSaludId o dejar null".
- [ ] **AuditModule:** registrar MongooseModule.forFeature([AuditEvent, AuditOutbox]). No registrar AuditService aún (solo schemas en este plan).
- [ ] **Expedientes/AppModule:** registrar schema DocumentVersion donde corresponda (en módulo expedientes o en audit según convención del proyecto).

---

## Tasks

<task>
**Task 04-02.1 — Schema AuditEvent e índices**
- Crear `src/modules/audit/schemas/audit-event.schema.ts`: definición Mongoose con todos los campos indicados. Collection name ej. `auditevents`. Timestamps: usar timestamp del evento (campo timestamp), no createdAt de Mongoose si se desea control total para el hash. Índices compuestos: (proveedorSaludId, timestamp), (proveedorSaludId, actorId, timestamp), (proveedorSaludId, resourceType, resourceId, timestamp). Documentar en comentario: "append-only; no usar update/delete".
</task>

<task>
**Task 04-02.2 — Schema audit_outbox**
- Crear `src/modules/audit/schemas/audit-outbox.schema.ts`: campos necesarios para reintento de eventos Clase 2. Índice (processedAt, createdAt) para drenado. Sin lógica de worker en este plan; solo modelo para escribir y consultar.
</task>

<task>
**Task 04-02.3 — Schema document_versions**
- Crear `src/modules/expedientes/schemas/document-version.schema.ts` (o bajo audit si las versiones son solo para auditoría): documentType (string), documentId (ObjectId), version (number), snapshot (Schema.Types.Mixed con el documento completo), proveedorSaludId, createdBy (ObjectId), createdAt (Date). Índice único compuesto (proveedorSaludId, documentType, documentId, version) para evitar duplicados y consulta por versión.
</task>

<task>
**Task 04-02.4 — GiisExportAudit proveedorSaludId e índice**
- En `src/modules/giis-export/schemas/giis-export-audit.schema.ts`: añadir @Prop() proveedorSaludId (Types.ObjectId, opcional para no romper datos existentes). Añadir índice (proveedorSaludId, fechaHora). Documentar en comentario: "Migración: backfill proveedorSaludId desde GiisBatch.proveedorSaludId para documentos existentes; nuevos registros deben incluir proveedorSaludId".
</task>

<task>
**Task 04-02.5 — Registrar schemas en módulos**
- En audit.module.ts: MongooseModule.forFeature([AuditEventSchema, AuditOutboxSchema]). Exportar schemas si otros módulos los necesitan.
- Registrar DocumentVersion en el módulo que gestione expedientes (expedientes.module o app).
- No crear servicios de escritura/lectura en este plan; solo modelos e índices.
</task>

---

## Verification

**Estado document_versions:** La parte de schema document_versions / DocumentVersion y endpoints de versiones fue removida. El resguardado se cumple con documentos inalterables y Notas Aclaratorias.

- Build pasa. Schemas e índices se crean al arrancar la app (Mongoose crea índices según definición).
- No hay migración automática de datos en este plan; decisión de backfill GiisExportAudit documentada.

---

## Criterios de aceptación NOM-024 (este plan)

- AuditEvent cumple D5 (proveedorSaludId obligatorio, índices mínimos).
- Versionado por documento completo (D2) queda soportado por schema document_versions.
- Append-only y cadena (hashEvento, hashEventoAnterior) soportados por modelo (D4).
