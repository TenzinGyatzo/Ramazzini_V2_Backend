---
wave: 4
depends_on: [04-02, 04-04]
files_modified:
  - src/modules/audit/audit.controller.ts
  - src/modules/audit/audit.service.ts
  - src/modules/audit/dto/export-audit.dto.ts
  - frontend/src/views/AuditoriaView.vue
autonomous: false
---

# Plan 04-05 — Capa 5: Export verificable (incl. hashes)

**Objetivo:** Endpoint de export del audit trail (CSV o JSON) por rango de fechas y filtros, incluyendo columnas hashEvento y hashEventoAnterior para verificación externa (D6). Endpoint (o lógica) de verificación que recalcule hashes y compare. Registrar evento AUDIT_EXPORT_DOWNLOAD (lectura sensible) al descargar.

---

## must_haves

- [ ] **GET /audit/export (o POST con body):** Params: from, to (obligatorios), format (csv | json), opcionalmente actorId, resourceType, resourceId. Respuesta: stream o buffer del archivo. Cabeceras: Content-Disposition con nombre de archivo sugerido. Contenido: cada fila/objeto incluye timestamp, actorId, actionType, resourceType, resourceId, payload (resumido si es grande), hashEvento, hashEventoAnterior. Siempre filtrado por proveedorSaludId del usuario. Export por lotes si el rango es grande (evitar cargar todo en memoria).
- [ ] **Formato verificable:** En JSON: array de objetos con los mismos campos que se usan para el hash canónico (orden de llaves consistente) más hashEvento y hashEventoAnterior. En CSV: columnas equivalentes; hashes en columnas dedicadas. Documentar en spec que un proceso externo puede recalcular SHA-256 del payload canónico por fila y comparar con hashEvento.
- [ ] **Verificación:** Endpoint GET /audit/verify o POST que reciba un export (o rango) y devuelva { valid: boolean, errors?: { index, expectedHash, actualHash }[] }. Lógica: por cada evento en el rango, reconstruir payload canónico, calcular hash, comparar con hashEvento almacenado; verificar cadena (hashEventoAnterior del evento i === hashEvento del evento i-1). Opcional: aceptar archivo subido para verificar export ya descargado.
- [ ] **Evento AUDIT_EXPORT_DOWNLOAD:** Al servir el export (en controller o service), llamar auditService.record(AUDIT_EXPORT_DOWNLOAD, resourceType: 'audit_export', payload: { from, to, format }, proveedorSaludId, actorId, CLASS_1_HARD_FAIL). Así la descarga del audit trail queda registrada (D1 lectura sensible).
- [ ] **UI:** En AuditoriaView, botón "Exportar" que abra modal o redirija a GET /audit/export?from=...&to=...&format=csv (o json). Descarga del archivo sin necesidad de mostrar contenido en pantalla.

---

## Tasks

<task>
**Task 04-05.1 — Servicio de export**
- En AuditService: método exportEvents(proveedorSaludId, from, to, format, options?): Promise&lt;Buffer&gt; o stream. Obtener eventos con find filtrado por proveedorSaludId y rango [from, to], orden timestamp asc (orden cronológico para cadena). Por cada evento, incluir en la salida: campos canónicos + hashEvento + hashEventoAnterior. Para JSON: array de objetos; para CSV: cabecera + filas. No incluir _id en el payload canónico de la salida si se usa para verificación (o documentar que el verificador usa los mismos campos que canonical-json.spec).
- Respuesta con Content-Type application/json o text/csv y Content-Disposition attachment; filename con rango de fechas.
</task>

<task>
**Task 04-05.2 — Controller GET /audit/export**
- Endpoint GET /audit/export con query from, to, format (csv|json). Obtener proveedorSaludId del usuario. Llamar auditService.exportEvents. Antes de devolver respuesta, llamar auditService.record(AUDIT_EXPORT_DOWNLOAD, ...) con CLASS_1_HARD_FAIL (si falla record, falla la descarga según D8 para lecturas sensibles). Devolver archivo con res.send(buffer) y headers apropiados.
</task>

<task>
**Task 04-05.3 — Verificación**
- Método auditService.verifyExport(proveedorSaludId, from, to): obtener eventos en rango, por cada uno recalcular hash canónico (usar misma función que en record), comparar con hashEvento; verificar hashEventoAnterior en cadena. Devolver { valid, errors }. Endpoint GET /audit/verify?from=&to= o POST con body { from, to }. Respuesta 200 con { valid: true } o { valid: false, errors: [...] }. Solo para el proveedor del usuario.
</task>

<task>
**Task 04-05.4 — UI Export**
- En AuditoriaView: botón "Exportar auditoría". Al pulsar, abrir GET /audit/export?from={filtroFrom}&to={filtroTo}&format=csv (o selector csv/json) en nueva pestaña o con fetch y descarga de blob. Mostrar mensaje de éxito o error.
</task>

---

## Verification

- Export descargado contiene columnas hashEvento y hashEventoAnterior. Verificación con /audit/verify para el mismo rango devuelve valid: true si no hubo alteración.
- Si se altera un evento en BD (simulación), verify debe devolver valid: false y al menos un error.
- Al descargar export, se crea un evento AUDIT_EXPORT_DOWNLOAD en el trail.

---

## Criterios de aceptación NOM-024 (este plan)

- Export verificable con hashes (D6); auditor puede recomprobar integridad.
- Lectura sensible "descarga del audit trail" registrada (D1).
