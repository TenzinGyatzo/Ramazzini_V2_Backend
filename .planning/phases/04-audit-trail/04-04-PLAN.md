---
wave: 4
depends_on: [04-03]
files_modified:
  - src/modules/audit/audit.controller.ts
  - src/modules/audit/audit.service.ts
  - src/modules/audit/dto/query-audit-events.dto.ts
  - src/modules/expedientes/expedientes.controller.ts
  - src/modules/expedientes/expedientes.service.ts
  - frontend/src/views/AuditoriaView.vue
  - frontend/src/router/index.ts
  - frontend/src/views/LayOut.vue
autonomous: false
---

# Plan 04-04 — Capa 4: APIs de consulta y UI mínima de auditoría

**Objetivo:** API NestJS para consultar eventos de auditoría filtrados por proveedorSaludId (obligatorio), actor, rango de fechas, expediente/recurso; paginación. UI mínima: ruta "Auditoría", filtros por expediente/actor/fecha, tabla de eventos. Todas las consultas segregadas por proveedorSaludId (D5).

---

## must_haves

- [ ] **GET /audit/events:** Query params: proveedorSaludId (implícito desde token/contexto, no expuesto), from (date), to (date), actorId, resourceType, resourceId (ej. expedienteId), actionType, page, limit. Respuesta: { items: AuditEvent[], total, page, limit }. Siempre filtrar por proveedorSaludId del usuario autenticado; nunca devolver eventos de otro proveedor.
- [ ] **GET /expedientes/:documentType/:id/versions (o equivalente):** Listar versiones de un documento (document_versions) para vista before/after. Respuesta: array de { version, createdAt, createdBy } ordenado por version desc. Solo documentos del proveedor y con permiso de lectura.
- [ ] **GET /expedientes/:documentType/:id/versions/:version:** Obtener snapshot completo de la versión N (reconstrucción fiel D2). Respuesta: documento tal cual en esa versión. Criterio de aceptación NOM-024: poder recuperar estado anterior.
- [ ] **UI mínima:** Nueva vista AuditoriaView.vue: filtros (rango fechas, actor opcional, recurso/expediente opcional), tabla con columnas timestamp, actor, acción, recurso, resourceId. Consumir GET /audit/events. Ruta protegida (ej. Principal/Administrador). Entrada en menú LayOut: "Auditoría" (o "Trail de auditoría").
- [ ] **Control de acceso:** Solo usuarios con rol que pueda ver auditoría (según política del proyecto); backend exige autenticación y deriva proveedorSaludId del usuario para filtrar.

---

## Tasks

<task>
**Task 04-04.1 — DTO y servicio de consulta**
- Crear QueryAuditEventsDto: from, to (ISO date), actorId?, resourceType?, resourceId?, actionType?, page (default 1), limit (default 50). Validación con class-validator.
- En AuditService: método findEvents(proveedorSaludId: string, query: QueryAuditEventsDto): Promise&lt;{ items: AuditEvent[], total: number }&gt;. find con filtro proveedorSaludId + condiciones opcionales; sort timestamp desc; skip/limit para paginación. Usar índices (proveedorSaludId, timestamp) y opcionalmente (proveedorSaludId, actorId), (proveedorSaludId, resourceType, resourceId).
</task>

<task>
**Task 04-04.2 — Controller GET /audit/events**
- Crear AuditController con GET events. Obtener proveedorSaludId del request (usuario autenticado → proveedor). Llamar auditService.findEvents(proveedorSaludId, query). Devolver { items, total, page, limit }. Proteger con guard de autenticación y rol si aplica.
</task>

<task>
**Task 04-04.3 — Endpoints de versiones de documento**
- En expedientes.controller (o audit.controller): GET /expedientes/:documentType/:id/versions que liste versiones desde document_versions para ese documentType + documentId + proveedorSaludId. GET /expedientes/:documentType/:id/versions/:version que devuelva el snapshot de esa versión (solo lectura). Expedientes.service: métodos listVersions(documentType, documentId, proveedorSaludId) y getVersion(documentType, documentId, version, proveedorSaludId). Validar que el documento pertenezca al proveedor.
</task>

<task>
**Task 04-04.4 — Vista AuditoriaView y ruta**
- Crear frontend/src/views/AuditoriaView.vue: formulario de filtros (fecha desde/hasta, actor opcional, recurso opcional), botón buscar, tabla con resultados (timestamp, actor, actionType, resourceType, resourceId). Llamar API GET /audit/events con query params. Paginación simple (página siguiente/anterior o select de página).
- Registrar ruta /auditoria (o /audit) apuntando a AuditoriaView. Proteger con meta.requiresAuth y meta.roles si aplica.
</task>

<task>
**Task 04-04.5 — Menú y acceso**
- En LayOut.vue añadir entrada de menú "Auditoría" (o "Trail de auditoría") visible para roles Principal/Administrador (o según política). Enlazar a la ruta de AuditoriaView. Documentar en CONTEXT que la UI mínima es consulta por expediente/actor/fecha.
</task>

---

## Verification

**Estado document_versions:** La parte de schema document_versions / DocumentVersion y endpoints de versiones fue removida. El resguardado se cumple con documentos inalterables y Notas Aclaratorias.

- GET /audit/events con usuario proveedor A no devuelve eventos de proveedor B.
- Listar versiones de un documento finalizado devuelve al menos la versión 1 (snapshot al finalizar); GET version/1 devuelve el documento completo de esa versión.
- UI: al filtrar por fechas y buscar, se muestran eventos del proveedor en tabla.

---

## Criterios de aceptación NOM-024 (este plan)

- Consulta por expediente/actor/fecha disponible (entregable d).
- Reconstrucción fiel: obtener versión N de un documento (D2).
- Segregación por proveedor en todas las consultas (D5).
