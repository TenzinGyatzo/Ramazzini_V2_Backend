---
wave: 5
depends_on: [04-03, 04-04, 04-05]
files_modified:
  - test/nom024/audit-trail.nom024.spec.ts
  - test/nom024/audit-reconstruction.nom024.spec.ts
  - test/nom024/audit-tamper-evident.nom024.spec.ts
  - test/nom024/audit-class1-class2.nom024.spec.ts
autonomous: false
---

# Plan 04-06 — Capa 6: Pruebas de aceptación orientadas a NOM-024

**Objetivo:** Tests que demuestren cumplimiento de los criterios de aceptación del CONTEXT: reconstrucción de versión previa, no updates destructivos en resguardado, toda acción con actor único, eventos append-only y tamper-evident, Clase 1 falla operación, Clase 2 outbox. No ampliar alcance; cada test debe ser verificable y ligado a una decisión D1–D8.

---

## must_haves

- [ ] **Reconstrucción de versión previa (D2):** Test: dado un documento clínico finalizado (estado FINALIZADO) con al menos una corrección (nueva versión), obtener la versión anterior vía GET /expedientes/:documentType/:id/versions/:version; el contenido debe coincidir con el snapshot guardado en document_versions. Test: comparar versión 1 y versión 2 (before/after) y verificar que son diferentes donde se aplicó la corrección.
- [ ] **No updates destructivos en resguardado (D3):** Test: PATCH o PUT sobre documento con estado FINALIZADO en proveedor NOM-024 debe devolver 403 o 409. Test: solo la creación de corrección (nueva versión) debe ser la vía permitida para "cambios" en documento resguardado.
- [ ] **Toda acción con actor único:** Test: cada evento en AuditEvent tiene exactamente un actorId (o "SYSTEM"). Test: eventos de finalizar, corrección, anular, export GIIS tienen actorId poblado y consistente con el usuario que ejecutó la acción.
- [ ] **Eventos append-only y tamper-evident (D4):** Test: no existen operaciones update/delete sobre la colección AuditEvent en el código de aplicación (búsqueda de .update, .findOneAndUpdate, .delete sobre el modelo). Test de verificación de cadena: exportar rango de eventos, llamar a /audit/verify y obtener valid: true. Test: si se modifica manualmente un documento en la colección (en test), verify debe devolver valid: false.
- [ ] **Clase 1 (hard-fail):** Test: al finalizar documento, si el registro en AuditEvent falla (mock del modelo que rechaza insert), la operación de finalización debe fallar (no debe persistirse estado FINALIZADO). Test análogo para export GIIS: si audit falla, el batch no debe marcarse como completado o la respuesta debe ser error.
- [ ] **Clase 2 (soft-fail) y audit_outbox:** Test: en login fallido, si el registro en AuditEvent falla, la respuesta al usuario debe seguir siendo 401 (o la que corresponda) y debe existir una entrada en audit_outbox con el payload del evento no registrado. Test: no se lanza excepción al cliente por el fallo de audit en Clase 2.
- [ ] **Segregación por proveedor (D5):** Test: usuario de proveedor A que consulta GET /audit/events no recibe eventos de proveedor B. Test: export y verify solo consideran eventos del proveedor del usuario.
- [ ] **Checklist de eventos (D7):** Test (integración o E2E): tras login exitoso hay evento LOGIN_SUCCESS; tras finalizar documento hay DOC_FINALIZE; tras disparar export GIIS hay al menos GIIS_EXPORT_STARTED y GIIS_EXPORT_FILE_GENERATED; tras descargar export audit hay AUDIT_EXPORT_DOWNLOAD. Opcional: test por cada actionType del checklist.

---

## Tasks

<task>
**Task 04-06.1 — Tests de reconstrucción y no destructivos**
- Crear test/nom024/audit-reconstruction.nom024.spec.ts: setup con documento finalizado y una versión; crear corrección (segunda versión). GET version/1 y version/2; afirmar que el contenido de version/1 es el snapshot original y version/2 el corregido. Test: PATCH sobre documento FINALIZADO (proveedor NOM-024) espera 403 o 409.
</task>

<task>
**Task 04-06.2 — Tests tamper-evident y append-only**
- Crear test/nom024/audit-tamper-evident.nom024.spec.ts: generar eventos en un rango; llamar export y verify, afirmar valid: true. Modificar en memoria o en BD un hashEvento de un evento (en test); volver a verify y afirmar valid: false. Grep o análisis estático: no usar update/delete sobre AuditEvent en código de producción (documentar en test o en script).
</task>

<task>
**Task 04-06.3 — Tests Clase 1 y Clase 2**
- Crear test/nom024/audit-class1-class2.nom024.spec.ts: mock AuditEvent.insertOne para que falle. Llamar finalizar documento (Clase 1): afirmar que se lanza excepción y el documento no queda finalizado. Llamar login fallido (Clase 2): afirmar que la respuesta es 401 y que hay una entrada en audit_outbox con el evento no registrado.
</task>

<task>
**Task 04-06.4 — Tests de segregación y checklist**
- En test/nom024/audit-trail.nom024.spec.ts (o repartir): usuario proveedor A crea eventos; usuario proveedor B consulta GET /audit/events con mismo rango; afirmar que la lista de B no contiene eventos de A. Test de humo: ejecutar flujos login, finalizar, export GIIS, export audit y comprobar que existen los eventos esperados en AuditEvent con actionType correcto.
</task>

---

## Verification

- `npm run test:nom024` (o comando equivalente) incluye los nuevos specs y pasan.
- Criterios de aceptación del CONTEXT cubiertos por al menos un test cada uno.
- No tests que amplíen alcance (ej. auditar lecturas genéricas, firma digital).

---

## Criterios de aceptación NOM-024 (este plan)

- Pruebas de reconstrucción de versión previa (CONTEXT).
- No updates destructivos en resguardado (CONTEXT).
- Toda acción con actor único; eventos append-only y tamper-evident (CONTEXT).
- Clase 1/2 y outbox verificados en tests.
