---
wave: 2
depends_on: [03-01]
files_modified:
  - frontend/src/views/LayOut.vue
  - frontend/src/router/index.ts
  - frontend/src/views/ExportacionGiisView.vue
  - frontend/src/api/giisExportAPI.ts
autonomous: true
---

# Plan 03-02 — Frontend: menú, ruta y vista Exportación GIIS

**Objetivo:** Implementar la UI de Exportación GIIS según CONTEXT.md: entrada en el menú desplegable de LayOut (solo Principal y Administrador, solo si tenant SIRES); ruta y vista con formulario mes/año, generación con spinner, listado de batches con columnas y descargas por archivo (CDT, CEX, LES), mensajes de error y detalle, aviso 9998, y deshabilitar “Generar” cuando hay un job en curso.

**Contexto:** CONTEXT.md fija nombre “Exportación GIIS”, roles Principal/Administrador, no mostrar opción si no es SIRES; descarga por archivo (CDT, CEX, LES); mostrar advertencias/excluidos y aviso 9998; un job a la vez; estado vacío con mensaje y formulario visible.

---

## must_haves

- [ ] **Menú LayOut:** En el menú desplegable, nueva opción “Exportación GIIS” que navega a la ruta de exportación GIIS. Visible solo si user.user?.role === 'Principal' || user.user?.role === 'Administrador', y solo si proveedor tiene giisExportEnabled (o isSIRES según política). Incluir la ruta de esta vista en la condición que muestra el menú (donde se listan 'inicio', 'add-user', etc.) para que el desplegable aparezca en esa pantalla.
- [ ] **Ruta:** Añadir ruta bajo LayOut (children), path ej. "/exportacion-giis", name "exportacion-giis", component ExportacionGiisView.vue. Protección: meta o guard que restrinja a Principal/Administrador y redirija a inicio si no; opcionalmente comprobar SIRES y redirigir si no aplica (o mostrar mensaje en vista).
- [ ] **Vista ExportacionGiisView:** (1) Formulario: selector mes y año (solo mes/año; establecimiento por defecto en backend). Botón “Generar”. Durante la generación: spinner y mensaje “Generando informes GIIS…”; deshabilitar botón y mostrar “Hay una generación en curso. Espere a que termine.” cuando exista un batch en estado generating o cuando se acaba de enviar y se está esperando respuesta. (2) Listado: tabla (o lista) con columnas mes reportado (yearMonth), fecha de generación (completedAt), estado (Listo/Error/En proceso), y por fila con estado Listo: enlaces de descarga separados por archivo (CDT, CEX, LES) usando GET /giis-export/batches/:batchId/download/:guide con descarga directa (sin nueva pestaña). Orden por defecto: mes reportado descendente. (3) Estado vacío: mensaje “Aún no hay reportes GIIS. Use el botón de arriba para generar el primero” y formulario visible. (4) Errores: si status === 'failed', mostrar mensaje claro y en listado o al expandir/clic: resumen (ej. “N errores de validación”) y enlace o botón para ver detalle / descargar reporte de excluidos (GET batches/:batchId/excluded-report?format=csv). (5) Aviso 9998: si establecimientoClues === '9998', mostrar en la fila o en un banner “Reporte en modo privado (CLUES 9998)”. (6) Advertencias/excluidos: si validationStatus es has_warnings o hay excludedReport, mostrar resumen junto a los enlaces de descarga (ej. “X registros excluidos”) y opción de descargar reporte de excluidos.
- [ ] **API cliente:** Crear frontend/src/api/giisExportAPI.ts (o equivalente) con: listBatches(), createBatch(yearMonth), getBatch(batchId), getExcludedReportCsvUrl(batchId), getDownloadUrl(batchId, guide). Usar base URL del backend (VITE_API_URL o la que use el proyecto). Las descargas pueden ser abriendo la URL con token en cabecera o usando window.location / fetch con blob según cómo esté configurado el axios (incluir credenciales para que la cookie o Authorization se envíe).
- [ ] **Un job a la vez:** Antes de llamar createBatch, comprobar si hay algún batch con status 'generating'; si lo hay, no enviar y mostrar mensaje. Tras enviar createBatch, considerar “en curso” hasta recibir respuesta (el backend genera síncronamente y devuelve status completed/failed), por lo que durante la petición el botón deshabilitado y spinner es suficiente. Si el backend en el futuro fuera asíncrono, se podría hacer polling a getBatch hasta que status !== 'generating'.
- [ ] **Guard de ruta (opcional):** Si el router tiene guards por rol, asegurar que la ruta exportacion-giis exija Principal o Administrador y, si se desea, que el tenant sea SIRES (redirigir a inicio o mostrar mensaje en vista).

---

## Tasks

<task>
**Task 03-02.1 — API giisExportAPI y rutas**
- Crear frontend/src/api/giisExportAPI.ts con funciones que llamen al backend: listBatches() → GET giis-export/batches; createBatch(yearMonth: string) → POST giis-export/batches body { yearMonth }; getBatch(batchId) → GET giis-export/batches/:batchId; getDownloadFileUrl(batchId, guide) para construir URL de descarga (o función que dispare descarga con axios/fetch y blob y trigger download). getExcludedReportCsvUrl(batchId) para descarga CSV. Usar el cliente HTTP existente (axios desde lib/axios o similar) para que envíe credenciales/token.
- En frontend/src/router/index.ts añadir child de LayOut: path "/exportacion-giis", name "exportacion-giis", component import ExportacionGiisView.vue. Añadir meta requiresPrincipalOrAdmin o similar si existe ese patrón; si no, validar en vista o en beforeEnter que el rol sea Principal o Administrador.
</task>

<task>
**Task 03-02.2 — Menú LayOut: opción Exportación GIIS**
- En LayOut.vue, dentro del bloque del menú desplegable (donde están Configuración, Gestión de Usuarios), añadir un bloque que muestre el enlace “Exportación GIIS” con v-if="(user.user?.role === 'Principal' || user.user?.role === 'Administrador') && giisExportEnabled". Para giisExportEnabled usar el store de proveedor (proveedorSaludStore.giisExportEnabled o useRegulatoryPolicy().giisExportEnabled). Al hacer clic, router.push({ name: 'exportacion-giis' }). Incluir 'exportacion-giis' en la condición que controla la visibilidad del menú (la lista de route.name que incluye 'inicio', 'add-user', ...) para que el menú se muestre también en esa ruta.
</task>

<task>
**Task 03-02.3 — Vista ExportacionGiisView: formulario y estado de generación**
- Crear ExportacionGiisView.vue. Estado: listBatches (array), loading (listado), generating (boolean para spinner de generación), selectedYearMonth (string YYYY-MM), errorMessage (string).
- onMounted (o similar): cargar listado con listBatches() y guardar en listBatches. Comprobar si hay batch con status 'generating' para deshabilitar botón y mostrar “Hay una generación en curso…” (en esta fase el backend es síncrono, pero si no hay batch generating, al pulsar Generar poner generating=true hasta que createBatch termine).
- Formulario: input o selectores para mes y año (combinar en YYYY-MM). Botón “Generar”: deshabilitado si generating o si existe algún batch en estado generating. Al enviar: set generating true, errorMessage null; llamar createBatch(selectedYearMonth); al terminar, refrescar listado y mostrar el nuevo batch (o mensaje de error); set generating false. Durante generating mostrar spinner y texto “Generando informes GIIS…”.
- Si el tenant no es SIRES, no se mostrará el menú (ya condicionado); si alguien entra por URL, se puede mostrar mensaje “Exportación GIIS solo disponible para tenants SIRES” y no mostrar formulario (comprobar giisExportEnabled o isSIRES al montar).
</task>

<task>
**Task 03-02.4 — Vista: listado, descargas, errores y 9998**
- En la misma vista, sección de listado: tabla o cards con columnas Mes reportado (yearMonth), Fecha de generación (completedAt formateado), Estado (mapear status a “Listo”/“Error”/“En proceso”). Por cada fila con status 'completed': tres enlaces o botones “Descargar CDT”, “Descargar CEX”, “Descargar LES” que disparen descarga con getDownloadFileUrl(batchId, guide) (descarga directa en el navegador). Para status 'failed': mostrar errorMessage y opción “Ver detalle” o “Descargar reporte de excluidos” (enlace a excluded-report?format=csv). Mostrar resumen de excludedReport (ej. “N registros excluidos”) cuando validationStatus sea has_warnings o has_blockers y haya totalExcluded.
- Si establecimientoClues === '9998', mostrar en esa fila un aviso “Reporte en modo privado (CLUES 9998)”.
- Estado vacío: si listBatches.length === 0, mostrar mensaje “Aún no hay reportes GIIS. Use el botón de arriba para generar el primero” y mantener el formulario visible arriba.
- Orden: listado ya viene ordenado por yearMonth desc del backend; mostrar en ese orden.
</task>

---

## Verification

- Usuario Principal o Administrador con tenant SIRES ve la opción “Exportación GIIS” en el menú y puede navegar a la vista.
- Usuario sin rol Principal/Administrador o tenant no SIRES no ve la opción (y si accede por URL, se maneja con redirección o mensaje).
- Formulario permite elegir mes/año y al generar se muestra spinner “Generando informes GIIS…” y al terminar aparece el nuevo batch en el listado.
- Listado muestra mes, fecha, estado y enlaces de descarga por CDT, CEX, LES para batches completados; descarga directa sin nueva pestaña.
- Batches con error muestran mensaje y opción a reporte de excluidos; batches con 9998 muestran aviso.
- Un job a la vez: botón deshabilitado durante la petición de generación.

---

## Checkpoints

- Ninguno.
