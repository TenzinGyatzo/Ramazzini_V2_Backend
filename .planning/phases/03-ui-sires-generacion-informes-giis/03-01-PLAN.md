---
wave: 1
depends_on: []
files_modified:
  - src/modules/giis-export/giis-export.controller.ts
  - src/modules/giis-export/giis-batch.service.ts
autonomous: true
---

# Plan 03-01 — Backend: listar batches GIIS del tenant

**Objetivo:** Exponer un endpoint que devuelva la lista de batches de exportación GIIS del tenant (proveedor de salud del usuario autenticado), ordenados por mes reportado descendente, para que la UI pueda mostrar el historial. Respetar SIRES: el controller ya valida régimen en otros endpoints; el listado solo debe incluir batches del proveedor del usuario.

**Contexto:** CONTEXT.md exige listado con columnas mes reportado, fecha de generación, estado, descarga. El backend hoy tiene GET /giis-export/batches/:batchId pero no GET /giis-export/batches. La UI consumirá este listado para la tabla de historial.

---

## must_haves

- [ ] **GET /giis-export/batches** (sin :batchId): lista de batches del tenant. Obtener proveedor del usuario con getProveedorSaludIdFromRequest; si el proveedor no es SIRES_NOM024, devolver 403 igual que en createBatch (o devolver array vacío según política — decidir: 403 es consistente con “no mostrar la opción”).
- [ ] Respuesta: array de objetos con batchId, yearMonth, status, completedAt (fecha de generación), validationStatus, establecimientoClues (para aviso 9998 en UI), errorMessage (para filas en error), y resumen de excludedReport (ej. totalExcluded) para mostrar “N errores” en la UI. Incluir artifacts con guide para que el cliente sepa si hay archivo por guía (descarga CDT/CEX/LES).
- [ ] Orden: por yearMonth descendente (mes más reciente primero).
- [ ] No paginación en esta fase (CONTEXT: “todos los batches del tenant”; si en el futuro hay muchos, se puede añadir límite).

---

## Tasks

<task>
**Task 03-01.1 — GiisBatchService.listBatchesForProveedor**
- En GiisBatchService añadir método listBatchesForProveedor(proveedorSaludId: string): Promise&lt;BatchListItem[]&gt;.
- Consultar giisBatchModel.find({ proveedorSaludId }).sort({ yearMonth: -1 }).lean().exec().
- Mapear cada doc a objeto con batchId (_id.toString()), yearMonth, status, completedAt, validationStatus, establecimientoClues, errorMessage, excludedReport: { totalExcluded } (solo total si existe), artifacts (array con guide y path para cada uno). Definir interfaz BatchListItem en el controller o en un dto.
- No exponer paths completos sensibles si no hace falta; la UI descargará vía GET /batches/:batchId/download/:guide. Incluir en cada artifact al menos guide y un flag o path para que el cliente sepa que puede llamar a download.
</task>

<task>
**Task 03-01.2 — Controller GET /giis-export/batches**
- En GiisExportController añadir endpoint GET batches (ruta 'batches' sin param). Obtener proveedorSaludId con getProveedorSaludIdFromRequest.
- Verificar régimen SIRES: obtener policy con regulatoryPolicyService.getRegulatoryPolicy(proveedorSaludId); si policy.regime !== 'SIRES_NOM024', lanzar ForbiddenException con el mismo mensaje que createBatch.
- Llamar a giisBatchService.listBatchesForProveedor(proveedorSaludId) y devolver el array en el body.
- No requiere guard de roles en backend si la app ya restringe por rol en frontend; el backend solo restringe por tenant y SIRES.
</task>

---

## Verification

- GET /giis-export/batches con usuario de tenant SIRES devuelve 200 y array de batches ordenados por yearMonth desc.
- GET /giis-export/batches con usuario de tenant no SIRES devuelve 403.
- Cada elemento del array incluye batchId, yearMonth, status, completedAt, validationStatus, establecimientoClues, errorMessage y resumen de excludedReport para la UI.

---

## Checkpoints

- Ninguno.
